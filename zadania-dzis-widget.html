<!--
  Publiczny Dashboard Zadaniomat
  Wstaw ten kod na stronƒô WordPressa jako w≈Çasny HTML.
  Dostƒôpny dla wszystkich odwiedzajƒÖcych (tylko podglƒÖd, bez edycji).
-->

<div id="zadaniomat-dashboard">
  <style>
    :root {
      --zd-bg: #0f172a;
      --zd-card: #1e293b;
      --zd-card-hover: #334155;
      --zd-border: #334155;
      --zd-text: #f1f5f9;
      --zd-text-muted: #94a3b8;
      --zd-primary: #3b82f6;
      --zd-primary-hover: #2563eb;
      --zd-success: #22c55e;
      --zd-warning: #f59e0b;
      --zd-danger: #ef4444;
      --zd-purple: #a855f7;
    }

    #zadaniomat-dashboard {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--zd-bg);
      color: var(--zd-text);
      padding: 30px;
      border-radius: 16px;
      min-height: 600px;
    }

    #zadaniomat-dashboard * {
      box-sizing: border-box;
    }

    .zd-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      gap: 20px;
    }

    .zd-title {
      font-size: 1.8em;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--zd-primary), var(--zd-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .zd-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .zd-select, .zd-input {
      background: var(--zd-card);
      border: 1px solid var(--zd-border);
      color: var(--zd-text);
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.2s;
    }

    .zd-select:hover, .zd-input:hover {
      border-color: var(--zd-primary);
    }

    .zd-select:focus, .zd-input:focus {
      outline: none;
      border-color: var(--zd-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .zd-btn {
      background: var(--zd-primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .zd-btn:hover {
      background: var(--zd-primary-hover);
      transform: translateY(-1px);
    }

    .zd-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .zd-stat-card {
      background: var(--zd-card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--zd-border);
    }

    .zd-stat-label {
      font-size: 0.85em;
      color: var(--zd-text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .zd-stat-value {
      font-size: 2em;
      font-weight: 700;
    }

    .zd-stat-value.success { color: var(--zd-success); }
    .zd-stat-value.warning { color: var(--zd-warning); }
    .zd-stat-value.primary { color: var(--zd-primary); }
    .zd-stat-value.purple { color: var(--zd-purple); }

    .zd-progress-bar {
      height: 8px;
      background: var(--zd-border);
      border-radius: 4px;
      margin-top: 12px;
      overflow: hidden;
    }

    .zd-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--zd-primary), var(--zd-success));
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .zd-section {
      background: var(--zd-card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid var(--zd-border);
    }

    .zd-section-title {
      font-size: 1.2em;
      font-weight: 600;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .zd-section-title span {
      font-size: 1.2em;
    }

    .zd-goals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
    }

    .zd-goal-card {
      background: var(--zd-bg);
      border-radius: 8px;
      padding: 16px;
      border-left: 4px solid var(--zd-primary);
    }

    .zd-goal-category {
      font-size: 0.8em;
      color: var(--zd-primary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .zd-goal-text {
      color: var(--zd-text);
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .zd-goal-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      font-size: 0.85em;
    }

    .zd-goal-status.achieved {
      color: var(--zd-success);
    }

    .zd-goal-status.not-achieved {
      color: var(--zd-danger);
    }

    .zd-tasks-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .zd-task-day {
      margin-bottom: 24px;
    }

    .zd-task-day-header {
      font-size: 0.9em;
      font-weight: 600;
      color: var(--zd-text-muted);
      padding-bottom: 8px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--zd-border);
    }

    .zd-task-item {
      display: flex;
      align-items: flex-start;
      padding: 14px 16px;
      margin-bottom: 8px;
      background: var(--zd-bg);
      border-radius: 8px;
      transition: all 0.2s;
      gap: 14px;
    }

    .zd-task-item:hover {
      background: var(--zd-card-hover);
    }

    .zd-task-item.completed {
      opacity: 0.7;
    }

    .zd-task-item.completed .zd-task-name {
      text-decoration: line-through;
      color: var(--zd-text-muted);
    }

    .zd-task-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 2px solid var(--zd-border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 2px;
    }

    .zd-task-item.completed .zd-task-checkbox {
      background: var(--zd-success);
      border-color: var(--zd-success);
    }

    .zd-task-checkbox::after {
      content: '';
    }

    .zd-task-item.completed .zd-task-checkbox::after {
      content: '‚úì';
      color: white;
      font-size: 14px;
      font-weight: bold;
    }

    .zd-task-content {
      flex: 1;
      min-width: 0;
    }

    .zd-task-name {
      font-size: 1em;
      color: var(--zd-text);
      margin-bottom: 6px;
      word-break: break-word;
    }

    .zd-task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 0.8em;
      color: var(--zd-text-muted);
    }

    .zd-task-category {
      background: rgba(59, 130, 246, 0.2);
      color: var(--zd-primary);
      padding: 3px 10px;
      border-radius: 4px;
      font-weight: 500;
    }

    .zd-task-time {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .zd-task-time.actual {
      color: var(--zd-success);
    }

    .zd-task-time-range {
      color: var(--zd-purple);
      font-weight: 500;
    }

    .zd-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--zd-text-muted);
    }

    .zd-empty-icon {
      font-size: 4em;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .zd-loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--zd-text-muted);
    }

    .zd-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--zd-border);
      border-top-color: var(--zd-primary);
      border-radius: 50%;
      animation: zd-spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes zd-spin {
      to { transform: rotate(360deg); }
    }

    .zd-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .zd-tab {
      padding: 10px 20px;
      background: transparent;
      border: 1px solid var(--zd-border);
      color: var(--zd-text-muted);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9em;
    }

    .zd-tab:hover {
      border-color: var(--zd-primary);
      color: var(--zd-text);
    }

    .zd-tab.active {
      background: var(--zd-primary);
      border-color: var(--zd-primary);
      color: white;
    }

    .zd-date-range {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .zd-date-range label {
      color: var(--zd-text-muted);
      font-size: 0.9em;
    }

    .zd-error {
      text-align: center;
      padding: 40px 20px;
      color: var(--zd-danger);
      background: rgba(239, 68, 68, 0.1);
      border-radius: 12px;
    }

    @media (max-width: 768px) {
      #zadaniomat-dashboard {
        padding: 16px;
      }

      .zd-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .zd-filters {
        width: 100%;
      }

      .zd-select, .zd-input {
        flex: 1;
        min-width: 120px;
      }
    }
  </style>

  <div class="zd-header">
    <h1 class="zd-title">Zadaniomat Dashboard</h1>
    <div class="zd-filters">
      <select id="zd-rok-select" class="zd-select">
        <option value="">Wybierz rok...</option>
      </select>
      <select id="zd-okres-select" class="zd-select">
        <option value="">Wszystkie okresy</option>
      </select>
    </div>
  </div>

  <div class="zd-stats-grid" id="zd-stats">
    <div class="zd-stat-card">
      <div class="zd-stat-label">Zadania ≈ÇƒÖcznie</div>
      <div class="zd-stat-value primary" id="zd-stat-total">-</div>
    </div>
    <div class="zd-stat-card">
      <div class="zd-stat-label">Uko≈Ñczone</div>
      <div class="zd-stat-value success" id="zd-stat-completed">-</div>
      <div class="zd-progress-bar">
        <div class="zd-progress-fill" id="zd-progress" style="width: 0%"></div>
      </div>
    </div>
    <div class="zd-stat-card">
      <div class="zd-stat-label">Czas planowany</div>
      <div class="zd-stat-value warning" id="zd-stat-planned">-</div>
    </div>
    <div class="zd-stat-card">
      <div class="zd-stat-label">Czas faktyczny</div>
      <div class="zd-stat-value purple" id="zd-stat-actual">-</div>
    </div>
  </div>

  <div class="zd-section" id="zd-cele-rok-section" style="display:none;">
    <h2 class="zd-section-title"><span>üéØ</span> Cele roczne (90 dni)</h2>
    <div class="zd-goals-grid" id="zd-cele-rok"></div>
  </div>

  <div class="zd-section" id="zd-cele-okres-section" style="display:none;">
    <h2 class="zd-section-title"><span>üìå</span> Cele okresu</h2>
    <div class="zd-goals-grid" id="zd-cele-okres"></div>
  </div>

  <div class="zd-section">
    <h2 class="zd-section-title"><span>üìã</span> Zadania</h2>

    <div class="zd-tabs" id="zd-date-tabs">
      <button class="zd-tab active" data-range="today">Dzi≈õ</button>
      <button class="zd-tab" data-range="week">Ten tydzie≈Ñ</button>
      <button class="zd-tab" data-range="period">Ca≈Çy okres</button>
      <button class="zd-tab" data-range="custom">W≈Çasny zakres</button>
    </div>

    <div class="zd-date-range" id="zd-custom-dates" style="display:none; margin-bottom: 20px;">
      <label>Od:</label>
      <input type="date" id="zd-date-start" class="zd-input">
      <label>Do:</label>
      <input type="date" id="zd-date-end" class="zd-input">
      <button class="zd-btn" id="zd-apply-dates">Zastosuj</button>
    </div>

    <div id="zd-tasks-container">
      <div class="zd-loading">
        <div class="zd-loading-spinner"></div>
        <p>≈Åadowanie zada≈Ñ...</p>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  // Automatyczne wykrycie ajaxurl dla WordPressa
  var ajaxurl = (typeof window.ajaxurl !== 'undefined')
    ? window.ajaxurl
    : '/wp-admin/admin-ajax.php';

  var state = {
    roki: [],
    okresy: [],
    selectedRok: null,
    selectedOkres: null,
    currentDateRange: 'today',
    customStart: null,
    customEnd: null
  };

  // Mapowanie kategorii na skr√≥ty (dla prywatno≈õci)
  var categoryShortcodes = {
    'zapianowany': 'ZP',
    'klejpan': 'KP',
    'marka_langer': 'ML',
    'marketing_construction': 'MC',
    'fjo': 'FJO',
    'obsluga_telefoniczna': 'OB'
  };

  function getCategoryCode(kategoria, label) {
    if (kategoria && categoryShortcodes[kategoria]) {
      return categoryShortcodes[kategoria];
    }
    if (label) {
      return label.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 3);
    }
    return '?';
  }

  // Helpers
  function formatTime(minutes) {
    if (!minutes || minutes == 0) return '0';
    var h = Math.floor(minutes / 60);
    var m = minutes % 60;
    if (h > 0 && m > 0) return h + 'h ' + m + 'min';
    if (h > 0) return h + 'h';
    return m + 'min';
  }

  function formatDatePL(dateStr) {
    var days = ['niedziela', 'poniedzia≈Çek', 'wtorek', '≈õroda', 'czwartek', 'piƒÖtek', 'sobota'];
    var months = ['stycznia', 'lutego', 'marca', 'kwietnia', 'maja', 'czerwca',
                  'lipca', 'sierpnia', 'wrze≈õnia', 'pa≈∫dziernika', 'listopada', 'grudnia'];
    var d = new Date(dateStr);
    return days[d.getDay()] + ', ' + d.getDate() + ' ' + months[d.getMonth()];
  }

  function escapeHtml(text) {
    if (!text) return '';
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function post(action, data) {
    var formData = new FormData();
    formData.append('action', action);
    for (var key in data) {
      formData.append(key, data[key]);
    }
    return fetch(ajaxurl, {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    }).then(function(r) { return r.json(); });
  }

  function getDateRange() {
    var today = new Date();
    var todayStr = today.toISOString().split('T')[0];
    var start, end;

    switch (state.currentDateRange) {
      case 'today':
        start = end = todayStr;
        break;
      case 'week':
        var dayOfWeek = today.getDay();
        var mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        var monday = new Date(today);
        monday.setDate(today.getDate() + mondayOffset);
        var sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        start = monday.toISOString().split('T')[0];
        end = sunday.toISOString().split('T')[0];
        break;
      case 'period':
        if (state.selectedOkres) {
          var okres = state.okresy.find(function(o) { return o.id == state.selectedOkres; });
          if (okres) {
            start = okres.data_start;
            end = okres.data_koniec;
          }
        } else if (state.selectedRok) {
          var rok = state.roki.find(function(r) { return r.id == state.selectedRok; });
          if (rok) {
            start = rok.data_start;
            end = rok.data_koniec;
          }
        }
        if (!start) {
          start = end = todayStr;
        }
        break;
      case 'custom':
        start = state.customStart || todayStr;
        end = state.customEnd || todayStr;
        break;
      default:
        start = end = todayStr;
    }

    return { start: start, end: end };
  }

  // Loaders
  function loadRoki() {
    post('zadaniomat_public_get_roki', {}).then(function(res) {
      if (res.success) {
        state.roki = res.data.roki || [];
        var select = document.getElementById('zd-rok-select');
        select.innerHTML = '<option value="">Wybierz rok...</option>';
        state.roki.forEach(function(rok) {
          var opt = document.createElement('option');
          opt.value = rok.id;
          opt.textContent = rok.nazwa + ' (' + rok.data_start + ' - ' + rok.data_koniec + ')';
          select.appendChild(opt);
        });

        // Auto-select current rok
        var today = new Date().toISOString().split('T')[0];
        var currentRok = state.roki.find(function(r) {
          return r.data_start <= today && r.data_koniec >= today;
        });
        if (currentRok) {
          select.value = currentRok.id;
          state.selectedRok = currentRok.id;
          loadOkresy(currentRok.id);
          loadCeleRok(currentRok.id);
        } else if (state.roki.length > 0) {
          // Je≈õli nie ma aktualnego, wybierz pierwszy
          select.value = state.roki[0].id;
          state.selectedRok = state.roki[0].id;
          loadOkresy(state.roki[0].id);
          loadCeleRok(state.roki[0].id);
        } else {
          loadTasks();
          loadStats();
        }
      }
    }).catch(function(err) {
      console.error('Error loading roki:', err);
      document.getElementById('zd-tasks-container').innerHTML =
        '<div class="zd-error">Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z serwerem. Sprawd≈∫ czy plugin Zadaniomat jest aktywny.</div>';
    });
  }

  function loadOkresy(rokId) {
    post('zadaniomat_public_get_okresy', { rok_id: rokId }).then(function(res) {
      if (res.success) {
        state.okresy = res.data.okresy || [];
        var select = document.getElementById('zd-okres-select');
        select.innerHTML = '<option value="">Wszystkie okresy</option>';
        state.okresy.forEach(function(okres) {
          var opt = document.createElement('option');
          opt.value = okres.id;
          opt.textContent = okres.nazwa + ' (' + okres.data_start + ' - ' + okres.data_koniec + ')';
          select.appendChild(opt);
        });

        // Auto-select current okres
        var today = new Date().toISOString().split('T')[0];
        var currentOkres = state.okresy.find(function(o) {
          return o.data_start <= today && o.data_koniec >= today;
        });
        if (currentOkres) {
          select.value = currentOkres.id;
          state.selectedOkres = currentOkres.id;
          loadCeleOkres(currentOkres.id);
        }

        loadTasks();
        loadStats();
      }
    });
  }

  function loadCeleRok(rokId) {
    post('zadaniomat_public_get_cele_rok', { rok_id: rokId }).then(function(res) {
      if (res.success) {
        var cele = res.data.cele || {};
        var kategorie = res.data.kategorie || {};
        var container = document.getElementById('zd-cele-rok');
        var section = document.getElementById('zd-cele-rok-section');

        var html = '';
        var hasGoals = false;
        for (var kat in kategorie) {
          if (cele[kat] && cele[kat].cel) {
            hasGoals = true;
            html += '<div class="zd-goal-card">';
            html += '<div class="zd-goal-category">' + getCategoryCode(kat, kategorie[kat]) + '</div>';
            html += '<div class="zd-goal-text">' + escapeHtml(cele[kat].cel) + '</div>';
            html += '</div>';
          }
        }

        container.innerHTML = html;
        section.style.display = hasGoals ? 'block' : 'none';
      }
    });
  }

  function loadCeleOkres(okresId) {
    post('zadaniomat_public_get_cele_okres', { okres_id: okresId }).then(function(res) {
      if (res.success) {
        var cele = res.data.cele || {};
        var kategorie = res.data.kategorie || {};
        var container = document.getElementById('zd-cele-okres');
        var section = document.getElementById('zd-cele-okres-section');

        var html = '';
        var hasGoals = false;
        for (var kat in kategorie) {
          if (cele[kat] && cele[kat].cel) {
            hasGoals = true;
            var status = '';
            if (cele[kat].osiagniety === '1' || cele[kat].osiagniety === 1) {
              status = '<div class="zd-goal-status achieved">‚úì OsiƒÖgniƒôty</div>';
            } else if (cele[kat].osiagniety === '0' || cele[kat].osiagniety === 0) {
              status = '<div class="zd-goal-status not-achieved">‚úó Nie osiƒÖgniƒôty</div>';
            }

            html += '<div class="zd-goal-card">';
            html += '<div class="zd-goal-category">' + getCategoryCode(kat, kategorie[kat]) + '</div>';
            html += '<div class="zd-goal-text">' + escapeHtml(cele[kat].cel) + '</div>';
            if (cele[kat].status !== null && cele[kat].status !== '') {
              html += '<div class="zd-progress-bar" style="margin-top:10px"><div class="zd-progress-fill" style="width:' + (parseFloat(cele[kat].status) * 100) + '%"></div></div>';
            }
            html += status;
            if (cele[kat].uwagi) {
              html += '<div style="margin-top:8px;font-size:0.85em;color:var(--zd-text-muted);">' + escapeHtml(cele[kat].uwagi) + '</div>';
            }
            html += '</div>';
          }
        }

        container.innerHTML = html;
        section.style.display = hasGoals ? 'block' : 'none';
      }
    });
  }

  function loadStats() {
    var range = getDateRange();
    post('zadaniomat_public_get_stats', { start: range.start, end: range.end }).then(function(res) {
      if (res.success) {
        var stats = res.data.stats || {};
        document.getElementById('zd-stat-total').textContent = stats.total || 0;
        document.getElementById('zd-stat-completed').textContent = stats.completed || 0;
        document.getElementById('zd-stat-planned').textContent = formatTime(stats.planned_time);
        document.getElementById('zd-stat-actual').textContent = formatTime(stats.actual_time);

        var pct = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
        document.getElementById('zd-progress').style.width = pct + '%';
      }
    });
  }

  function loadTasks() {
    var range = getDateRange();
    var container = document.getElementById('zd-tasks-container');
    container.innerHTML = '<div class="zd-loading"><div class="zd-loading-spinner"></div><p>≈Åadowanie zada≈Ñ...</p></div>';

    post('zadaniomat_public_get_tasks', { start: range.start, end: range.end }).then(function(res) {
      if (res.success) {
        var tasks = res.data.tasks || [];

        if (tasks.length === 0) {
          container.innerHTML = '<div class="zd-empty"><div class="zd-empty-icon">üì≠</div><p>Brak zada≈Ñ w wybranym zakresie</p></div>';
          return;
        }

        // Group by day
        var byDay = {};
        tasks.forEach(function(task) {
          if (!byDay[task.dzien]) byDay[task.dzien] = [];
          byDay[task.dzien].push(task);
        });

        var html = '';
        var days = Object.keys(byDay).sort();
        days.forEach(function(day) {
          html += '<div class="zd-task-day">';
          html += '<div class="zd-task-day-header">' + formatDatePL(day) + '</div>';
          html += '<ul class="zd-tasks-list">';

          byDay[day].forEach(function(task) {
            var isCompleted = parseFloat(task.status) >= 1;
            var timeRange = task.godzina_start && task.godzina_koniec
              ? task.godzina_start.slice(0,5) + ' - ' + task.godzina_koniec.slice(0,5)
              : (task.godzina_start ? 'od ' + task.godzina_start.slice(0,5) : '');

            html += '<li class="zd-task-item ' + (isCompleted ? 'completed' : '') + '">';
            html += '<div class="zd-task-checkbox"></div>';
            html += '<div class="zd-task-content">';
            html += '<div class="zd-task-name">' + escapeHtml(task.zadanie) + '</div>';
            html += '<div class="zd-task-meta">';
            if (task.kategoria) {
              html += '<span class="zd-task-category">' + getCategoryCode(task.kategoria, task.kategoria_label) + '</span>';
            }
            if (task.planowany_czas) {
              html += '<span class="zd-task-time">‚è± ' + formatTime(task.planowany_czas) + '</span>';
            }
            if (task.faktyczny_czas) {
              html += '<span class="zd-task-time actual">‚úì ' + formatTime(task.faktyczny_czas) + '</span>';
            }
            if (timeRange) {
              html += '<span class="zd-task-time-range">üïê ' + timeRange + '</span>';
            }
            html += '</div></div></li>';
          });

          html += '</ul></div>';
        });

        container.innerHTML = html;
      }
    }).catch(function(err) {
      console.error('Error loading tasks:', err);
      container.innerHTML = '<div class="zd-error">WystƒÖpi≈Ç b≈ÇƒÖd podczas ≈Çadowania zada≈Ñ.</div>';
    });
  }

  // Event handlers
  document.getElementById('zd-rok-select').addEventListener('change', function() {
    state.selectedRok = this.value;
    state.selectedOkres = null;
    document.getElementById('zd-okres-select').value = '';
    document.getElementById('zd-cele-okres-section').style.display = 'none';

    if (state.selectedRok) {
      loadOkresy(state.selectedRok);
      loadCeleRok(state.selectedRok);
    } else {
      document.getElementById('zd-cele-rok-section').style.display = 'none';
      loadTasks();
      loadStats();
    }
  });

  document.getElementById('zd-okres-select').addEventListener('change', function() {
    state.selectedOkres = this.value;
    if (state.selectedOkres) {
      loadCeleOkres(state.selectedOkres);
    } else {
      document.getElementById('zd-cele-okres-section').style.display = 'none';
    }
    loadTasks();
    loadStats();
  });

  document.querySelectorAll('.zd-tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.zd-tab').forEach(function(t) { t.classList.remove('active'); });
      this.classList.add('active');
      state.currentDateRange = this.dataset.range;

      var customDates = document.getElementById('zd-custom-dates');
      customDates.style.display = state.currentDateRange === 'custom' ? 'flex' : 'none';

      if (state.currentDateRange !== 'custom') {
        loadTasks();
        loadStats();
      }
    });
  });

  document.getElementById('zd-apply-dates').addEventListener('click', function() {
    state.customStart = document.getElementById('zd-date-start').value;
    state.customEnd = document.getElementById('zd-date-end').value;
    loadTasks();
    loadStats();
  });

  // Init
  loadRoki();
})();
</script>
