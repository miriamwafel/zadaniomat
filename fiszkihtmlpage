<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiszki - System Powtórek | Progresownik Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* =============================================
           ZMIENNE KOLORYSTYCZNE - LANGER BRANDING
           [cite: 53, 55, 58, 60, 62]
           ============================================= */
        :root {
            --deep-blue: #020C1B;       /*  Ciemny granat zastępujący czerń */
            --deep-blue-card: #0A192F;  /* Odcień dla kart, dla kontrastu */
            --flame: #FF4500;           /* [cite: 55] Nasycony pomarańczowy, przykuwa wzrok */
            --cobalt: #0044CC;          /* [cite: 58] Cobaltowy, profesjonalizm */
            --ash-grey: #8892b0;        /* [cite: 60] Minimalizm, neutralne tło */
            --light-grey: #E6F1FF;      /* [cite: 62] Dobry kontrast na czerni/cobalcie */
            --white: #FFFFFF;
            
            /* Fonty [cite: 34, 41] */
            --font-headers: 'Chakra Petch', sans-serif; /* Imitacja Uniwars (Geometryczny/Techniczny) */
            --font-body: 'Helvetica Neue', Helvetica, Arial, sans-serif; /* [cite: 41] Helvetica */
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: var(--deep-blue);
            color: var(--ash-grey);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        #fiszki-app {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            /* Subtelny wzór geometryczny w tle nawiązujący do "Wzoru Firmowego" */
            background-color: var(--deep-blue);
            background-image:
                linear-gradient(30deg, #051025 12%, transparent 12.5%, transparent 87%, #051025 87.5%, #051025),
                linear-gradient(150deg, #051025 12%, transparent 12.5%, transparent 87%, #051025 87.5%, #051025),
                linear-gradient(30deg, #051025 12%, transparent 12.5%, transparent 87%, #051025 87.5%, #051025),
                linear-gradient(150deg, #051025 12%, transparent 12.5%, transparent 87%, #051025 87.5%, #051025),
                linear-gradient(60deg, #061229 25%, transparent 25.5%, transparent 75%, #061229 75%, #061229),
                linear-gradient(60deg, #061229 25%, transparent 25.5%, transparent 75%, #061229 75%, #061229);
            background-size: 80px 140px;
            background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;
        }

        /* BRANDING HEADER */
        .brand-header {
            text-align: center;
            margin-bottom: 30px;
            color: var(--white);
            font-family: var(--font-headers);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .brand-header span { color: var(--flame); } /* [cite: 56] Akcent pomarańczowy */
        
        /* PRZEŁĄCZNIK JĘZYKA */
        .jezyk-switcher {
            display: flex;
            justify-content: center;
            gap: 15px; /* Większy odstęp dla przejrzystości [cite: 24] */
            margin-bottom: 30px;
        }
        
        .jezyk-btn {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--ash-grey);
            background: transparent;
            color: var(--ash-grey);
            font-family: var(--font-headers); /* Geometryczny krój [cite: 5] */
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 0; /* Ostry, geometryczny kształt [cite: 5] */
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        
        .jezyk-btn:hover {
            border-color: var(--light-grey);
            color: var(--light-grey);
        }

        /* Aktywne stany zgodne z paletą kolorów [cite: 56, 59] */
        .jezyk-btn.active.hiszpanski {
            border-color: var(--flame);
            background: rgba(255, 69, 0, 0.1);
            color: var(--flame);
            box-shadow: 0 0 15px rgba(255, 69, 0, 0.2);
        }
        
        .jezyk-btn.active.angielski {
            border-color: var(--cobalt);
            background: rgba(0, 68, 204, 0.1);
            color: var(--cobalt);
            box-shadow: 0 0 15px rgba(0, 68, 204, 0.3);
        }

        .jezyk-btn::before {
            /* Element ozdobny "L" na przycisku  */
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 15px;
            height: 15px;
            border-bottom: 3px solid currentColor;
            border-left: 3px solid currentColor;
            opacity: 0.5;
        }
        
        .jezyk-btn .count {
            background: var(--deep-blue);
            padding: 2px 8px;
            font-size: 0.8rem;
            border: 1px solid currentColor;
        }

        .jezyk-btn .total-words {
            font-size: 0.7rem;
            opacity: 0.8;
            display: block;
            margin-top: 5px;
        }

        .word-count {
            font-size: 0.75rem;
            color: var(--ash-grey);
            background: rgba(255,255,255,0.05);
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 2px;
        }

        /* PROGRESS BANNER */
        .progress-banner {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--deep-blue-card);
            border: 1px solid #172a45;
        }

        .progress-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .progress-ring-container {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-ring {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-bg {
            fill: none;
            stroke: #172a45;
            stroke-width: 8;
        }

        .progress-ring-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring-fill.hiszpanski {
            stroke: var(--flame);
        }

        .progress-ring-fill.angielski {
            stroke: var(--cobalt);
        }

        .progress-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-percent {
            font-family: var(--font-headers);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--light-grey);
        }

        .progress-label {
            font-size: 0.7rem;
            color: var(--ash-grey);
            text-transform: uppercase;
        }

        .progress-info {
            text-align: center;
        }

        .progress-lang {
            font-family: var(--font-headers);
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .progress-lang.hiszpanski { color: var(--flame); }
        .progress-lang.angielski { color: var(--cobalt); }

        .progress-goal {
            font-size: 0.8rem;
            color: var(--ash-grey);
        }

        .progress-words {
            font-size: 0.75rem;
            color: var(--light-grey);
            margin-top: 3px;
        }

        @media (max-width: 600px) {
            .progress-banner {
                gap: 25px;
                padding: 20px 15px;
            }
            .progress-ring-container {
                width: 100px;
                height: 100px;
            }
            .progress-lang {
                font-size: 0.85rem;
            }
            .progress-goal {
                font-size: 0.7rem;
            }
            .progress-words {
                font-size: 0.7rem;
            }
            .progress-percent {
                font-size: 1.2rem;
            }
        }

        @media (max-width: 380px) {
            .progress-banner {
                flex-direction: column;
            }
            .progress-ring-container {
                width: 110px;
                height: 110px;
            }
            .progress-percent {
                font-size: 1.4rem;
            }
        }

        /* KARTY */
        .card {
            background: var(--deep-blue-card);
            border: 1px solid #172a45; /* Subtelna ramka */
            border-radius: 2px; /* Minimalne zaokrąglenie, bardziej techniczne */
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
        }

        /* Ozdobny pasek "L" na karcie [cite: 25, 30] */
        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--ash-grey);
        }
        
        .card:hover::after {
            background: var(--flame); /* Interakcja kolorem [cite: 55] */
            transition: background 0.3s;
        }
        
        .card h3 {
            margin: 0 0 20px 0;
            color: var(--light-grey); /* [cite: 62] */
            font-family: var(--font-headers);
            font-size: 1.3rem;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #172a45;
            padding-bottom: 10px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* PRZYCISKI NAWIGACJI */
        button {
            font-family: var(--font-headers);
            font-weight: 600;
        }

        .date-nav button, .calendar-nav button {
            background: transparent;
            border: 1px solid var(--cobalt); /* [cite: 58] */
            color: var(--cobalt);
            padding: 8px 15px;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.8rem;
        }
        
        .date-nav button:hover, .calendar-nav button:hover {
            background: var(--cobalt);
            color: var(--white);
        }
        
        .date-nav input[type="date"] {
            background: var(--deep-blue);
            border: 1px solid #233554;
            color: var(--light-grey);
            padding: 7px 10px;
            border-radius: 0;
            font-family: var(--font-body);
            color-scheme: dark;
        }
        
        /* LISTA ZADAŃ */
        .task-section { margin-bottom: 20px; }
        
        .task-section-header {
            font-family: var(--font-headers);
            font-size: 0.8rem;
            letter-spacing: 1px;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 2px solid;
            display: inline-block;
        }
        
        /* Kolory nagłówków sekcji */
        .task-section-header.nauka { border-color: var(--flame); color: var(--flame); } /* [cite: 55] */
        .task-section-header.p1 { border-color: var(--cobalt); color: var(--cobalt); } /* [cite: 58] */
        .task-section-header.powtorka { border-color: var(--ash-grey); color: var(--ash-grey); }
        
        .task-list { list-style: none; padding: 0; margin: 0; }
        
        .task-item {
            background: rgba(255,255,255,0.03);
            margin-bottom: 8px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 0; 
            border-right: 4px solid; /* Przeniesienie akcentu na prawą stronę dla oryginalności */
            transition: transform 0.2s;
        }
        
        .task-item:hover { transform: translateX(5px); background: rgba(255,255,255,0.05); }
        
        .task-item.nauka { border-color: var(--flame); }
        .task-item.p1 { border-color: var(--cobalt); }
        .task-item.p2, .task-item.p3, .task-item.p4 { border-color: var(--ash-grey); }
        
        .task-item .name { 
            color: var(--light-grey); 
            font-weight: 500; 
            font-size: 1.05rem;
        }
        .task-item .type { 
            font-family: var(--font-headers);
            font-size: 0.75rem; 
            opacity: 0.7;
            text-transform: uppercase;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--ash-grey);
            border: 1px dashed #233554;
            font-style: italic; /* Helvetica italic [cite: 42] */
        }
        
        .hidden-count {
            text-align: center;
            color: var(--flame);
            font-family: var(--font-headers);
            font-size: 0.8rem;
            margin-top: 15px;
            padding: 8px;
            border: 1px solid rgba(255, 69, 0, 0.3);
        }
        
        /* KALENDARZ */
        .calendar-month {
            color: var(--light-grey);
            font-family: var(--font-headers);
            font-weight: 700;
            min-width: 160px;
            text-align: center;
            text-transform: uppercase;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px; /* Minimalne odstępy dla geometrycznego wyglądu */
            margin-top: 20px;
            background: #172a45;
            border: 1px solid #172a45;
        }
        
        .calendar-header {
            text-align: center;
            color: var(--ash-grey);
            font-size: 0.75rem;
            padding: 10px;
            background: var(--deep-blue-card);
            text-transform: uppercase;
        }
        
        .calendar-day {
            text-align: center;
            padding: 15px 5px;
            background: var(--deep-blue-card); /* Domyślne tło */
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .calendar-day:hover { z-index: 10; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.5); border: 1px solid var(--flame); }
        
        .calendar-day .day-num { font-weight: 700; color: var(--light-grey); font-family: var(--font-headers); }
        .calendar-day .day-count { font-size: 0.7rem; color: var(--ash-grey); margin-top: 5px; }
        
        /* Obramowanie "DZISIAJ" w stylu Flame */
        .calendar-day.today { box-shadow: inset 0 0 0 2px var(--flame); }
        
        /* Load indicators - subtelne paski na dole zamiast pełnego tła, dla czystości */
        .calendar-day::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
        }
        
        .calendar-day.load-0::after { background: transparent; }
        .calendar-day.load-1::after { background: var(--ash-grey); }
        .calendar-day.load-2::after { background: var(--cobalt); }
        .calendar-day.load-3::after { background: #FF9F1C; } /* Pośredni */
        .calendar-day.load-4::after { background: var(--flame); } /* [cite: 55] */
        
        .calendar-legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: var(--ash-grey);
            justify-content: center;
        }
        
        .legend-color { width: 12px; height: 12px; }
        
        /* TABELA */
        .table-container { 
            overflow-x: auto; 
            border: 1px solid #172a45;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            font-family: var(--font-body); /* [cite: 40] Forma DJR/Helvetica dla bloków tekstu */
        }
        
        th {
            background: #172a45;
            color: var(--light-grey);
            padding: 15px;
            text-align: center;
            font-family: var(--font-headers);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }
        
        th:first-child { text-align: left; padding-left: 20px; }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #172a45;
            color: var(--ash-grey);
            text-align: center;
        }
        
        tr:hover td { background: rgba(255,255,255,0.02); }
        
        td:first-child { 
            text-align: left; 
            padding-left: 20px;
            color: var(--light-grey);
            font-weight: 500;
        }
        
        td.today { color: var(--flame); font-weight: bold; }
        td.done { color: var(--cobalt); opacity: 0.7; }
        
        .stats-row {
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--ash-grey);
            font-family: var(--font-headers);
            text-transform: uppercase;
            text-align: right;
        }
        
        /* RESPONSYWNOŚĆ */
        @media (max-width: 600px) {
            .jezyk-switcher { flex-direction: column; gap: 10px; }
            .jezyk-btn { width: 100%; }
            .card-header { flex-direction: column; align-items: stretch; }
            .date-nav { justify-content: space-between; margin-top: 10px; }
            .calendar-day { padding: 10px 2px; }
        }
    </style>
</head>
<body>

<div id="fiszki-app">

    <div class="brand-header">
        <h1>Progresownik Marcina <span>System</span></h1>
    </div>

    <!-- PROGRESS BANNER -->
    <div class="progress-banner">
        <div class="progress-item">
            <div class="progress-ring-container">
                <svg class="progress-ring" viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="52"/>
                    <circle class="progress-ring-fill hiszpanski" id="ring-hiszpanski" cx="60" cy="60" r="52"
                            stroke-dasharray="326.73" stroke-dashoffset="326.73"/>
                </svg>
                <div class="progress-center">
                    <div class="progress-percent" id="percent-hiszpanski">0%</div>
                    <div class="progress-label">B2</div>
                </div>
            </div>
            <div class="progress-info">
                <div class="progress-lang hiszpanski">Hiszpański</div>
                <div class="progress-goal">Cel: 2500 słówek</div>
                <div class="progress-words" id="words-progress-hiszpanski">0 / 2500</div>
            </div>
        </div>

        <div class="progress-item">
            <div class="progress-ring-container">
                <svg class="progress-ring" viewBox="0 0 120 120">
                    <circle class="progress-ring-bg" cx="60" cy="60" r="52"/>
                    <circle class="progress-ring-fill angielski" id="ring-angielski" cx="60" cy="60" r="52"
                            stroke-dasharray="326.73" stroke-dashoffset="326.73"/>
                </svg>
                <div class="progress-center">
                    <div class="progress-percent" id="percent-angielski">0%</div>
                    <div class="progress-label">C1</div>
                </div>
            </div>
            <div class="progress-info">
                <div class="progress-lang angielski">Angielski</div>
                <div class="progress-goal">Cel: 2000 słówek</div>
                <div class="progress-words" id="words-progress-angielski">0 / 2000</div>
            </div>
        </div>
    </div>

    <div class="jezyk-switcher">
        <button class="jezyk-btn hiszpanski active" onclick="setJezyk('hiszpanski')">
            ES • Hiszpański
            <span class="count" id="count-hiszpanski">-</span>
            <span class="total-words" id="words-hiszpanski">- słówek</span>
        </button>
        <button class="jezyk-btn angielski" onclick="setJezyk('angielski')">
            EN • Angielski
            <span class="count" id="count-angielski">-</span>
            <span class="total-words" id="words-angielski">- słówek</span>
        </button>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3><span style="color:var(--flame)">///</span> Zadania na <span id="selected-date-label">dziś</span></h3>
            <div class="date-nav">
                <button onclick="changeDate(-1)">PREV</button>
                <input type="date" id="date-picker">
                <button onclick="changeDate(1)">NEXT</button>
                <button onclick="goToToday()" style="border-color: var(--flame); color: var(--flame)">DZIŚ</button>
            </div>
        </div>
        <div id="tasks-container">Loading data...</div>
        <div id="tasks-stats" class="stats-row"></div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h3><span style="color:var(--cobalt)">///</span> Obciążenie</h3>
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">PREV</button>
                <span class="calendar-month" id="calendar-month"></span>
                <button onclick="changeMonth(1)">NEXT</button>
            </div>
        </div>
        <div class="calendar-grid" id="calendar-grid"></div>
        <div class="calendar-legend">
            <span><div class="legend-color" style="background:var(--ash-grey)"></div> 1</span>
            <span><div class="legend-color" style="background:var(--cobalt)"></div> 2</span>
            <span><div class="legend-color" style="background:#FF9F1C"></div> 3</span>
            <span><div class="legend-color" style="background:var(--flame)"></div> 4+</span>
        </div>
    </div>
    
    <div class="card">
        <h3><span style="color:var(--ash-grey)">///</span> Baza wiedzy <span id="jezyk-label-table"></span></h3>
        <div class="table-container" id="table-container">Loading data...</div>
    </div>
    
</div>

<script>
// =============================================
// KONFIGURACJA
// =============================================
const SITE_URL = 'https://progresownikmarcina.pl';
const LIMIT = 3;

let currentJezyk = 'hiszpanski';
let currentDate = new Date();
let currentMonth = new Date();

// =============================================
// API
// =============================================
const API = {
    date: (d, jezyk) => `${SITE_URL}/wp-json/fiszki/v1/date/${d}?jezyk=${jezyk}`,
    all: (jezyk) => `${SITE_URL}/wp-json/fiszki/v1/all?jezyk=${jezyk}`,
    load: (year, month, jezyk) => `${SITE_URL}/wp-json/fiszki/v1/load/${year}/${String(month).padStart(2, '0')}?jezyk=${jezyk}`,
    stats: () => `${SITE_URL}/wp-json/fiszki/v1/stats`,
};

// =============================================
// HELPERS
// =============================================
function toDateString(date) {
    return date.toISOString().split('T')[0];
}

function formatDatePL(dateStr) {
    if (!dateStr) return '—';
    const d = new Date(dateStr);
    return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
}

function formatDateLong(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' });
}

function isToday(dateStr) {
    return dateStr === toDateString(new Date());
}

function isPast(dateStr) {
    return dateStr < toDateString(new Date());
}

function getTypeClass(type) {
    if (type === 'nauka') return 'nauka';
    if (type === 'powtorka_1') return 'p1';
    return type.replace('powtorka_', 'p');
}

// Zmieniono etykiety na bardziej techniczne/geometryczne
function getTypeLabel(type) {
    switch(type) {
        case 'nauka': return 'NEW';
        case 'powtorka_1': return 'P1 [+3]';
        case 'powtorka_2': return 'P2 [+15]';
        case 'powtorka_3': return 'P3 [+40]';
        case 'powtorka_4': return 'P4 [+140]';
        default: return type;
    }
}

// =============================================
// JĘZYK
// =============================================
function setJezyk(jezyk) {
    currentJezyk = jezyk;
    
    // Aktualizuj przyciski
    document.querySelectorAll('.jezyk-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.jezyk-btn.${jezyk}`).classList.add('active');
    
    // Aktualizuj label w tabeli
    document.getElementById('jezyk-label-table').textContent = 
        jezyk === 'hiszpanski' ? 'ES' : 'EN';
    
    // Przeładuj wszystko
    loadTasks();
    loadCalendar();
    loadTable();
}

// Cele językowe
const GOALS = {
    hiszpanski: { words: 2500, level: 'B2' },
    angielski: { words: 2000, level: 'C1' }
};

function updateProgressRing(jezyk, currentWords) {
    const goal = GOALS[jezyk].words;
    const percent = Math.min(100, Math.round((currentWords / goal) * 100));
    const circumference = 2 * Math.PI * 52; // r=52
    const offset = circumference - (percent / 100) * circumference;

    const ring = document.getElementById(`ring-${jezyk}`);
    const percentEl = document.getElementById(`percent-${jezyk}`);
    const wordsEl = document.getElementById(`words-progress-${jezyk}`);

    if (ring) ring.style.strokeDashoffset = offset;
    if (percentEl) percentEl.textContent = `${percent}%`;
    if (wordsEl) wordsEl.textContent = `${currentWords} / ${goal}`;
}

async function loadStats() {
    try {
        const response = await fetch(API.stats());
        const data = await response.json();

        document.getElementById('count-hiszpanski').textContent = data.hiszpanski.today;
        document.getElementById('count-angielski').textContent = data.angielski.today;

        // Wyświetl łączną liczbę słówek per język
        const slowekHiszpanski = data.hiszpanski.slowek || 0;
        const slowekAngielski = data.angielski.slowek || 0;

        document.getElementById('words-hiszpanski').textContent = `${slowekHiszpanski} słówek`;
        document.getElementById('words-angielski').textContent = `${slowekAngielski} słówek`;

        // Aktualizuj pierścienie postępu
        updateProgressRing('hiszpanski', slowekHiszpanski);
        updateProgressRing('angielski', slowekAngielski);
    } catch (err) {
        console.error('Błąd statystyk:', err);
    }
}

// =============================================
// ZADANIA
// =============================================
function changeDate(days) {
    currentDate.setDate(currentDate.getDate() + days);
    document.getElementById('date-picker').value = toDateString(currentDate);
    loadTasks();
}

function goToToday() {
    currentDate = new Date();
    document.getElementById('date-picker').value = toDateString(currentDate);
    loadTasks();
}

async function loadTasks() {
    const container = document.getElementById('tasks-container');
    const statsDiv = document.getElementById('tasks-stats');
    const dateLabel = document.getElementById('selected-date-label');
    const dateStr = toDateString(currentDate);
    
    dateLabel.textContent = isToday(dateStr) ? 'dziś' : formatDateLong(dateStr);
    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--ash-grey)">/// SYSTEM LOADING...</div>';
    
    try {
        const response = await fetch(API.date(dateStr, currentJezyk));
        const data = await response.json();
        
        if (data.tasks.length === 0) {
            container.innerHTML = '<div class="empty-state">SYSTEM STATUS: CLEAR <br>Brak zadań na ten dzień.</div>';
            statsDiv.textContent = '';
            return;
        }
        
        // Grupowanie
        const nauka = data.tasks.filter(t => t.type === 'nauka');
        const p1 = data.tasks.filter(t => t.type === 'powtorka_1');
        const pozostale = data.tasks.filter(t => ['powtorka_2', 'powtorka_3', 'powtorka_4'].includes(t.type));
        
        let html = '';
        
        // NAUKA
        if (nauka.length > 0) {
            html += '<div class="task-section">';
            html += '<div class="task-section-header nauka">NAUKA [NEW]</div>';
            html += '<ul class="task-list">';
            nauka.forEach(t => {
                const wordsBadge = t.ilosc_slowek ? `<span class="word-count">${t.ilosc_slowek} sł.</span>` : '';
                html += `<li class="task-item nauka">
                    <span class="name">${t.name}${wordsBadge}</span>
                    <span class="type">D0</span>
                </li>`;
            });
            html += '</ul></div>';
        }
        
        // P1
        if (p1.length > 0) {
            html += '<div class="task-section">';
            html += '<div class="task-section-header p1">PRIORYTET [P1]</div>';
            html += '<ul class="task-list">';
            p1.forEach(t => {
                const wordsBadge = t.ilosc_slowek ? `<span class="word-count">${t.ilosc_slowek} sł.</span>` : '';
                html += `<li class="task-item p1">
                    <span class="name">${t.name}${wordsBadge}</span>
                    <span class="type">P1</span>
                </li>`;
            });
            html += '</ul></div>';
        }
        
        // Pozostałe
        if (pozostale.length > 0) {
            const pokazane = pozostale.slice(0, LIMIT);
            const ukryte = pozostale.length - pokazane.length;
            
            html += '<div class="task-section">';
            html += '<div class="task-section-header powtorka">STANDARD FLOW</div>';
            html += '<ul class="task-list">';
            pokazane.forEach(t => {
                const pNum = t.type.replace('powtorka_', 'P');
                const wordsBadge = t.ilosc_slowek ? `<span class="word-count">${t.ilosc_slowek} sł.</span>` : '';
                html += `<li class="task-item ${getTypeClass(t.type)}">
                    <span class="name">${t.name}${wordsBadge}</span>
                    <span class="type">${pNum}</span>
                </li>`;
            });
            html += '</ul>';
            
            if (ukryte > 0) {
                html += `<div class="hidden-count">WARN: +${ukryte} UKRYTYCH (LIMIT ${LIMIT})</div>`;
            }
            html += '</div>';
        }
        
        container.innerHTML = html;
        statsDiv.textContent = `TOTAL: ${data.count} | NEW: ${nauka.length} | P1: ${p1.length} | OLD: ${pozostale.length}`;
        
    } catch (err) {
        console.error('Błąd:', err);
        container.innerHTML = '<div style="color: var(--flame); text-align:center">ERROR: CONNECTION FAILED</div>';
    }
}

// =============================================
// KALENDARZ
// =============================================
function changeMonth(delta) {
    currentMonth.setMonth(currentMonth.getMonth() + delta);
    loadCalendar();
}

async function loadCalendar() {
    const grid = document.getElementById('calendar-grid');
    const monthLabel = document.getElementById('calendar-month');
    
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth() + 1;
    
    const monthNames = ['Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec', 
                        'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'];
    monthLabel.textContent = `${monthNames[month - 1]} ${year}`;
    
    grid.innerHTML = '<div style="grid-column: span 7; text-align: center; color: var(--ash-grey); padding:20px;">LOADING GRID...</div>';
    
    try {
        const response = await fetch(API.load(year, month, currentJezyk));
        const data = await response.json();
        
        const dayNames = ['PN', 'WT', 'ŚR', 'CZ', 'PT', 'SB', 'ND'];
        let html = dayNames.map(d => `<div class="calendar-header">${d}</div>`).join('');
        
        const firstDay = new Date(year, month - 1, 1);
        let startDay = firstDay.getDay() - 1;
        if (startDay < 0) startDay = 6;
        
        for (let i = 0; i < startDay; i++) {
            html += '<div style="background:var(--deep-blue-card)"></div>';
        }
        
        const today = toDateString(new Date());
        
        for (const [date, count] of Object.entries(data.load)) {
            const day = new Date(date).getDate();
            const isCurrentDay = date === today;
            // Klasy load-x używane teraz do paska dolnego
            const loadClass = count >= 4 ? 'load-4' : `load-${count}`;
            
            html += `<div class="calendar-day ${loadClass} ${isCurrentDay ? 'today' : ''}" onclick="selectDate('${date}')">
                <div class="day-num">${day}</div>
                <div class="day-count">${count > 0 ? count : '-'}</div>
            </div>`;
        }
        
        grid.innerHTML = html;
        
    } catch (err) {
        console.error('Błąd kalendarza:', err);
        grid.innerHTML = '<div style="grid-column: span 7; color: var(--flame); text-align:center">GRID ERROR</div>';
    }
}

function selectDate(date) {
    currentDate = new Date(date);
    document.getElementById('date-picker').value = date;
    loadTasks();
}

// =============================================
// TABELA
// =============================================
async function loadTable() {
    const container = document.getElementById('table-container');
    
    try {
        const response = await fetch(API.all(currentJezyk));
        const data = await response.json();
        
        if (data.fiszki.length === 0) {
            container.innerHTML = '<p style="color: var(--ash-grey); text-align: center; padding:20px;">DATABASE EMPTY.</p>';
            return;
        }
        
        const today = toDateString(new Date());
        
        let html = `<table>
            <thead>
                <tr>
                    <th>NAZWA</th>
                    <th>SŁ.</th>
                    <th>DATA</th>
                    <th>P1</th>
                    <th>P2</th>
                    <th>P3</th>
                    <th>P4</th>
                    <th>P5</th>
                </tr>
            </thead>
            <tbody>`;
        
        data.fiszki.forEach(f => {
            const cellClass = (date) => {
                if (date === today) return 'today';
                if (isPast(date)) return 'done';
                return '';
            };
            
            const check = (date) => isPast(date) ? ' ✓' : '';
            
            html += `<tr>
                <td>${f.name}</td>
                <td style="text-align:center; color: var(--flame);">${f.ilosc_slowek || '—'}</td>
                <td class="${cellClass(f.data_utworzenia)}">${formatDatePL(f.data_utworzenia)}${check(f.data_utworzenia)}</td>
                <td class="${cellClass(f.powtorka_1)}">${formatDatePL(f.powtorka_1)}${check(f.powtorka_1)}</td>
                <td class="${cellClass(f.powtorka_2)}">${formatDatePL(f.powtorka_2)}${check(f.powtorka_2)}</td>
                <td class="${cellClass(f.powtorka_3)}">${formatDatePL(f.powtorka_3)}${check(f.powtorka_3)}</td>
                <td class="${cellClass(f.powtorka_4)}">${formatDatePL(f.powtorka_4)}${check(f.powtorka_4)}</td>
                <td class="${cellClass(f.powtorka_5)}">${formatDatePL(f.powtorka_5)}${check(f.powtorka_5)}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        const totalWords = data.fiszki.reduce((sum, f) => sum + (f.ilosc_slowek || 0), 0);
        html += `<div class="stats-row">RECORDS: ${data.count} | SŁÓWEK: ${totalWords}</div>`;
        
        container.innerHTML = html;
        
    } catch (err) {
        console.error('Błąd tabeli:', err);
        container.innerHTML = '<div style="color: var(--flame); padding:20px;">DATA ERROR</div>';
    }
}

// =============================================
// INIT
// =============================================
document.addEventListener('DOMContentLoaded', function() {
    const today = toDateString(new Date());
    document.getElementById('date-picker').value = today;
    document.getElementById('jezyk-label-table').textContent = 'ES';
    
    loadStats();
    loadTasks();
    loadCalendar();
    loadTable();
    
    document.getElementById('date-picker').addEventListener('change', function() {
        currentDate = new Date(this.value);
        loadTasks();
    });
});
</script>

</body>
</html>
